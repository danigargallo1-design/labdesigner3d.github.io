<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>STL Viewer 3D SÃ³lido</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
* { box-sizing: border-box; font-family: 'Inter', sans-serif; }

body {
  margin: 0;
  height: 100vh;
  background:
    radial-gradient(circle at 30% 20%, #2a2a2a, #0b0b0b 70%);
  color: #eaeaea;
  overflow: hidden;
}

/* SCREENS */
.screen {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.hidden { display: none; }

/* UPLOAD */
.upload-box {
  background: linear-gradient(180deg, #1b1b1b, #121212);
  padding: 42px;
  border-radius: 22px;
  width: 380px;
  text-align: center;
  box-shadow: 0 30px 60px rgba(0,0,0,.6);
}

.upload-box h2 {
  margin-bottom: 22px;
  font-weight: 500;
}

button {
  width: 100%;
  padding: 15px;
  border-radius: 14px;
  border: none;
  background: linear-gradient(135deg, #1e88e5, #64b5f6);
  color: #fff;
  font-size: 16px;
  cursor: pointer;
  transition: transform .15s ease, box-shadow .15s ease;
}

button:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 30px rgba(100,181,246,.5);
}

input { display: none; }

/* VIEWER */
.viewer {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

canvas {
  background:
    radial-gradient(circle at top, #1a1a1a, #050505);
  border-radius: 22px;
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,.05),
    0 40px 80px rgba(0,0,0,.8);
}
</style>
</head>

<body>

<!-- UPLOAD -->
<div class="screen" id="upload">
  <div class="upload-box">
    <h2>Subir archivo STL</h2>
    <input type="file" id="file" accept=".stl">
    <button onclick="file.click()">Seleccionar STL</button>
  </div>
</div>

<!-- VIEWER -->
<div class="screen hidden" id="viewer">
  <canvas id="canvas"></canvas>
</div>

<script>
const file = document.getElementById('file');
const upload = document.getElementById('upload');
const viewer = document.getElementById('viewer');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

file.onchange = () => {
  const r = new FileReader();
  r.onload = e => drawSTL(e.target.result);
  r.readAsArrayBuffer(file.files[0]);
};

function drawSTL(buffer) {
  upload.classList.add('hidden');
  viewer.classList.remove('hidden');

  const size = Math.min(innerWidth, innerHeight) * 0.88;
  canvas.width = size;
  canvas.height = size;

  const view = new DataView(buffer);
  const faces = view.getUint32(80, true);
  let o = 84;
  const tris = [];

  for (let i = 0; i < faces; i++) {
    const nx = view.getFloat32(o, true); o+=4;
    const ny = view.getFloat32(o, true); o+=4;
    const nz = view.getFloat32(o, true); o+=4;

    const tri = [];
    for (let v = 0; v < 3; v++) {
      tri.push({
        x: view.getFloat32(o, true),
        y: view.getFloat32(o+4, true),
        z: view.getFloat32(o+8, true)
      });
      o += 12;
    }
    tris.push({ tri, normal:{x:nx,y:ny,z:nz} });
    o += 2;
  }

  let minX=1e9,maxX=-1e9,minY=1e9,maxY=-1e9,minZ=1e9,maxZ=-1e9;
  tris.forEach(t=>t.tri.forEach(p=>{
    minX=Math.min(minX,p.x); maxX=Math.max(maxX,p.x);
    minY=Math.min(minY,p.y); maxY=Math.max(maxY,p.y);
    minZ=Math.min(minZ,p.z); maxZ=Math.max(maxZ,p.z);
  }));

  const scale = size*0.46/Math.max(maxX-minX,maxY-minY);
  const depth = scale*0.65;

  function project(p){
    const x=p.x-(minX+maxX)/2;
    const y=p.y-(minY+maxY)/2;
    const z=p.z-(minZ+maxZ)/2;
    return {
      x:(x-y)*scale,
      y:(x+y)*scale*0.5 - z*depth,
      z
    };
  }

  const light = { x:0.3, y:0.5, z:1 };

  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,size,size);
  ctx.translate(size/2,size/2);

  tris
    .map(t=>{
      const pts=t.tri.map(project);
      const avgZ=pts.reduce((s,p)=>s+p.z,0)/3;
      const n=t.normal;
      const dot=Math.max(0,(n.x*light.x+n.y*light.y+n.z*light.z));
      return {pts,avgZ,shade:dot};
    })
    .sort((a,b)=>a.avgZ-b.avgZ)
    .forEach(f=>{
      ctx.beginPath();
      f.pts.forEach((p,i)=>i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));
      ctx.closePath();

      const base = 90 + f.shade*140;
      ctx.fillStyle = `rgb(${base}, ${base+25}, ${base+60})`;
      ctx.fill();

      ctx.strokeStyle = 'rgba(0,0,0,0.18)';
      ctx.lineWidth = 0.6;
      ctx.stroke();
    });
}
</script>

</body>
</html>
